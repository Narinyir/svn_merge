# SVN Sync Tool — Техническое задание

## 1. Цель инструмента

Инструмент предназначен для синхронизации папки контента (`Content`) между двумя независимыми SVN репозиториями:

1. **MAIN** — основной репозиторий с исходным кодом и uasset.
2. **OUTSOURCE** — репозиторий аутсорса, содержит только бинарники + uasset.

**Основные задачи:**

- Двусторонний синк uasset файлов.
- Выявление и классификация изменений:
  - Safe (изменения только в одном репозитории)
  - Conflict (изменения в обоих репозиториях, удаление, переименование)
- Возможность вручную выбирать, как разрешать конфликты.
- Генерация сообщения для коммита.

---

## 2. Архитектура

### Модули

| Файл | Назначение |
|------|------------|
| `main.py` | Точка входа, запуск приложения. |
| `ui_main.py` | UI на PyQt6, отображение таблиц, кнопок, вкладок. |
| `controller.py` | Контроллер, связывает UI и движок синка. |
| `sync_engine.py` | Логика сбора изменений, классификация safe/conflict. |
| `svn_adapter.py` | Работа с SVN через консоль (`subprocess`). |
| `config_manager.py` | Хранение путей, last_sync в `.ini`. |
| `logger_manager.py` | Логирование операций в `sync_tool.log`. |
| `sync_tool.ini` | Конфигурационный файл, хранит рабочие копии, last_sync. |

---

## 3. Основные функции

1. **Инициализация**

- Чтение `.ini`, загрузка путей:
  - `main_wc` — рабочая копия MAIN
  - `out_wc` — рабочая копия OUTSOURCE
  - `sync_folder` — папка для синка (`Content`)
- Проверка чистоты WC (`svn status`)  
- Получение HEAD ревизий (`svn info`)  

2. **Сканирование изменений**

- Получение ревизий с последнего sync (`last_sync`)  
- `svn log --summarize --xml` для MAIN и OUTSOURCE  
- Фильтрация по папке синка  
- Классификация:
  - **Safe** — изменения только в одной стороне
  - **Conflict** — изменения в обеих сторонах, удаление, A/A, D/M
- Хранение новых last_sync после сканирования

3. **Классификация конфликтов**

- **Изменено в обоих (M/M)** → conflict  
- **Удалено/изменено (D/M или M/D)** → conflict  
- **Добавлено в обоих (A/A)** → conflict  
- **Safe** — изменения только в одном репо

4. **UI — отображение изменений**

- Две вкладки:
  - **Без конфликтов** — safe
  - **Конфликты** — M/M, D/M, A/A
- Таблицы:
  - Safe: `Действие MAIN | Действие OUT | Файл`
  - Conflict: `MAIN | OUT | Файл | Решение` (dropdown)
- Цветовая схема:
  - 🔴 Красный — conflict
  - 🟢 Зелёный — safe
  - 🟡 Жёлтый — rename candidate

5. **UI — верхняя панель**

- Строка 1: рабочие копии MAIN и OUTSOURCE с кнопкой «Обзор» и иконкой 🖥  
- Строка 2: папка синка `Content` с кнопкой «Выбрать» и иконкой 📁  
- Строка 3: направление синхронизации (combobox):
  - Двусторонняя (MAIN ↔ OUTSOURCE)
  - Только MAIN → OUTSOURCE
  - Только OUTSOURCE → MAIN  
- Строка 4: информация о HEAD ревизиях и последней синхронизации

6. **UI — нижняя панель**

- Кнопки:
  - **Проверить изменения** — сканирует изменения, обновляет таблицы  
  - **Применить изменения** — блокирована пока есть нерешённые конфликты  
- Редактируемое поле **Сообщение для коммита**, которое пользователь потом использует вручную  

7. **Логика rename**

- Сначала пытаемся определить через SVN (`svn log --verbose`)  
- Если rename не найден → анализируем delete + add в одном коммите → пользователь подтверждает  
- Возможность отказаться от rename  

---

## 4. Поведение программы

1. Проверка `.ini` и чистоты WC. Если есть изменения → предупреждение.  
2. Пользователь выбирает рабочие копии и папку синка.  
3. При нажатии **«Проверить изменения»**:
   - Таблицы safe/conflict заполняются  
   - Apply заблокирован, если есть конфликты  
4. После решения конфликтов (dropdown):
   - Пользователь нажимает Apply → выполняются SVN операции (копирование, delete, rename)  
   - Генерируется сообщение для коммита  
5. После успешного применения обновляем last_sync в `.ini`.  

---

## 5. Дополнительные требования

- UI полностью на русском языке  
- Иконки для всех полей (path, папка)  
- Блокировка Apply пока есть нерешённые конфликты  
- Счётчик изменений и конфликтов  
- Без авто-refresh HEAD  
- Не коммитим автоматически — пользователь делает `svn commit` вручную  
- `.ini` и `.log` находятся рядом с тулзой  

---

## 6. Будущие шаги

1. Добавить dropdown для выбора действия при конфликте (MAIN/OUTSOURCE/rename)  
2. Реализовать Apply Engine (копирование, delete, rename через SVN)  
3. Расширить анализ rename через hash файлов  
4. Добавить визуальный индикатор прогресса при применении изменений  

---

## 7. Итоговая архитектура UI

┌─────────────────────────────────────────────┐
│ MAIN WC [Путь] [Обзор] │
│ OUT WC [Путь] [Обзор] │
│ Папка синка [Content] [Выбрать] │
│ Направление: [Двусторонняя ▼] │
│ MAIN: r135 | OUT: r94 | Last sync: MAIN r123, OUT r87
└─────────────────────────────────────────────┘
┌─────────────────────────────────────────────┐
│ Вкладки: │
│ ├─ Без конфликтов (зеленая таблица) │
│ │ Действие MAIN | Действие OUT | Файл │
│ └─ Конфликты (красная таблица) │
│ MAIN | OUT | Файл | Решение │
└─────────────────────────────────────────────┘
┌─────────────────────────────────────────────┐
│ Сообщение для коммита │
│ [Редактируемое поле] │
│ [Проверить изменения] [Применить изменения] │
└─────────────────────────────────────────────┘
---

Хочешь, я сразу могу сделать **готовый md файл в Codex**, который вставляется в репозиторий и уже лежит рядом с проектом?
